<script>
    const MAX_KAZANC = 10000000.00;
    let UPDATE_INTERVAL = 150; 
    
    // BAKIYE VE BAHİS
    let bakiye = 100.00;
    let aktifBahis = 10.00;
    const BASLANGIC_BAHIS = 10.00; // Martingale için başlangıç bahsi
    
    let oyunDurumu = 'bekliyor'; 
    let mevcutCarpan = 1.00;
    let oyunHiziCarpani = 1.0; 
    let animasyonFrameId;
    let sonGuncellemeZamani = 0;

    // OTO STRATEJİ & OTO BET DEĞİŞKENLERİ
    let otoStratejiAktif = false;
    let otoToplamaCarpani = 1.20; 
    let otoBetAktif = false;
    let oynananElSayisi = 0;
    let sonElDurumu = 'baslangic'; // 'kazanç', 'kayıp', 'baslangic'

    // Volatilite Değişkenleri
    let grafikNoktalari = []; 
    let dalgaFazı = 0; 
    let anaTrend = 0; 
    let dinamikZoom = 1.0; 

    // DOM
    const uiBakiye = document.getElementById('bakiyeGosterge');
    const uiBahis = document.getElementById('aktifBahisGosterge');
    const uiCarpan = document.getElementById('carpanGosterge');
    const uiBtn = document.getElementById('oynaToplaBtn');
    const uiListe = document.getElementById('sonuclarListesi');
    const canvas = document.getElementById('grafikCanvas');
    const ctx = canvas.getContext('2d');
    const backgroundMusic = document.getElementById('backgroundMusic');
    
    // OTO DOM
    const otoSwitch = document.getElementById('otoStratejiSwitch');
    const otoCarpanInput = document.getElementById('otoCarpanInput');
    const otoBaslatDurdurBtn = document.getElementById('otoBaslatDurdurBtn');
    const tekrarSayisiInput = document.getElementById('tekrarSayisi');
    const kayipStratejisiSelect = document.getElementById('kayipStratejisi');
    const kazancStratejisiSelect = document.getElementById('kazancStratejisi');

    // Başlangıçta UI ayarı
    updateUI(); 

    function resizeCanvas() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        if(grafikNoktalari.length > 0) drawGraph();
    }
    window.addEventListener('resize', resizeCanvas);
    // İlk yüklemede tuval boyutunu ayarla
    document.addEventListener('DOMContentLoaded', () => {
        resizeCanvas();
        // Boş grafiği göster
        drawGraph();
    });

    function updateUI() {
        uiBakiye.textContent = `₺${bakiye.toFixed(2)}`;
        uiBahis.textContent = `₺${aktifBahis.toFixed(2)}`;
    }
    
    // --- OTO BET YENİ FONKSİYONLAR ---

    function toggleOtoBet() {
        if (oyunDurumu === 'oynuyor') return;

        otoBetAktif = !otoBetAktif;
        if (otoBetAktif) {
            otoBaslatDurdurBtn.textContent = "OTO OYNATMAYI DURDUR";
            otoBaslatDurdurBtn.classList.add('active');
            oynananElSayisi = 0;
            sonElDurumu = 'baslangic';
            uygulaOtoBetStratejisi();
            oyunuBaslat();
        } else {
            otoBaslatDurdurBtn.textContent = "OTO OYNATMAYI BAŞLAT";
            otoBaslatDurdurBtn.classList.remove('active');
        }
    }
    
    function uygulaOtoBetStratejisi(oncekiBahisMiktari) {
        let strateji = '';
        let yeniBahis = oncekiBahisMiktari || aktifBahis;

        if (sonElDurumu === 'kayıp') {
            strateji = kayipStratejisiSelect.value;
        } else if (sonElDurumu === 'kazanç') {
            strateji = kazancStratejisiSelect.value;
        } else {
            aktifBahis = BASLANGIC_BAHIS;
            return;
        }

        switch (strateji) {
            case 'iki_kat':
                yeniBahis *= 2;
                break;
            case 'baslangic':
                yeniBahis = BASLANGIC_BAHIS;
                break;
            case 'aynı':
            default:
                yeniBahis = oncekiBahisMiktari;
                break;
        }
        
        aktifBahis = Math.max(1.00, Math.min(yeniBahis, 500.00));
        updateUI();
    }

    function oyunuTekrarBaslat() {
        if (otoBetAktif) {
            oynananElSayisi++;
            const maxTekrar = parseInt(tekrarSayisiInput.value);

            if (oynananElSayisi >= maxTekrar) {
                toggleOtoBet();
                return;
            }
            
            const oncekiBahis = aktifBahis;
            uygulaOtoBetStratejisi(oncekiBahis);
            
            setTimeout(() => {
                oyunuBaslat();
            }, 500); 
            
        } else {
            oyunDurumu = 'bekliyor';
        }
    }

    // --- GENEL OYUN FONKSİYONLARI ---

    function toggleOtoStrateji() {
        if(oyunDurumu === 'oynuyor') return; 
        
        otoStratejiAktif = !otoStratejiAktif;
        if (otoStratejiAktif) {
            otoSwitch.classList.add('on');
            let val = parseFloat(otoCarpanInput.value);
            otoToplamaCarpani = Math.max(val, 1.01); 
            otoCarpanInput.value = otoToplamaCarpani.toFixed(2);
        } else {
            otoSwitch.classList.remove('on');
        }
    }
    
    function setBahis(miktar) { if(oyunDurumu !== 'oynuyor') { aktifBahis = miktar; updateUI(); } }
    function ayarlaBahis(d) { setBahis(aktifBahis + d); }
    function setHiz(x) { 
        oyunHiziCarpani = x; 
        document.querySelectorAll('.hiz-ayarlari button').forEach(b => b.classList.remove('aktif'));
        event.target.classList.add('aktif');
    }

    function oyunuBaslat() {
        if (bakiye < aktifBahis) { 
            if (otoBetAktif) {
                toggleOtoBet();
                alert("Oto Oynatma Durduruldu: Bakiye Yetersiz!");
            } else {
                alert("Bakiye Yetersiz");
            }
            return; 
        }
        
        // KRİTİK DÜZELTME: Müzik hatasını engellemek için try/catch kullanıldı.
        try {
            if (backgroundMusic.paused) {
                 backgroundMusic.play().catch(e => console.warn("Müzik otomatik başlatılamadı:", e));
            }
        } catch (e) {
            console.warn("Müzik hatası:", e);
        }

        bakiye -= aktifBahis;
        updateUI();
        
        oyunDurumu = 'oynuyor';
        mevcutCarpan = 1.00;
        grafikNoktalari = [{val: 1.00}]; 
        
        dalgaFazı = Math.random() * 10;
        anaTrend = 0.01; 
        dinamikZoom = 1.0; 

        uiBtn.textContent = "TOPLA";
        uiBtn.classList.add('topla-modu');
        uiCarpan.textContent = "1.00x";
        uiCarpan.className = "carpan-gosterge"; 
        uiCarpan.style.color = "#00ff7f";
        
        sonGuncellemeZamani = performance.now();
        // BURADA OYUN DÖNGÜSÜ BAŞLIYOR
        animasyonFrameId = requestAnimationFrame(oyunDongusu);
    }

    function oyunDongusu(zaman) {
        if (oyunDurumu !== 'oynuyor') return;

        let hedeflenenSure = UPDATE_INTERVAL / oyunHiziCarpani;
        if (zaman - sonGuncellemeZamani > hedeflenenSure) {
            sonGuncellemeZamani = zaman;
            birAdimIlerle();
        }
        // Bir sonraki kareyi çağırmaya devam et
        requestAnimationFrame(oyunDongusu);
    }

    function birAdimIlerle() {
        // --- OTO TOPLAMA KONTROLÜ ---
        if (otoStratejiAktif && oyunDurumu === 'oynuyor') {
            if (mevcutCarpan >= otoToplamaCarpani) {
                oyunuBitir(true); 
                return;
            }
        }
        
        // VOLATİLİTE MATEMATİĞİ
        dalgaFazı += 0.2; 
        let dalgaEtkisi = Math.sin(dalgaFazı) * 0.10; 
        let gurultu = (Math.random() - 0.5) * 0.15; 
        
        if (mevcutCarpan < 0.80) anaTrend += 0.003; 
        else anaTrend = 0.015;

        let degisim = anaTrend + dalgaEtkisi + gurultu;
        
        if (Math.random() < 0.15) {
            degisim -= 0.20; 
        }

        let yeniDeger = mevcutCarpan + degisim;
        let gercekDegisim = yeniDeger - mevcutCarpan;
        
        if (yeniDeger < 0.15) {
            yeniDeger = 0.15;
            if(Math.random() < 0.5) anaTrend = 0.05; 
        }

        mevcutCarpan = yeniDeger;

        // DİNAMİK ZOOM HESAPLAMA
        let hiz = Math.abs(gercekDegisim) * 20; 
        if (mevcutCarpan > 2.00) hiz += 0.5;
        
        let hedefZoom = 1.0 + Math.min(hiz, 0.4); 
        dinamikZoom += (hedefZoom - dinamikZoom) * 0.1; 

        // CRASH KONTROLLERİ
        let patlamaSansi = 0.005; 
        if (mevcutCarpan < 0.50) patlamaSansi = 0.01; 
        if (mevcutCarpan > 2.0) patlamaSansi = 0.015;
        if (mevcutCarpan > 5.0) patlamaSansi = 0.04;
        if (mevcutCarpan > 10.0) patlamaSansi = 0.08;

        if (Math.random() < patlamaSansi) {
             mevcutCarpan = 0.00;
             oyunuBitir(false);
             return;
        }

        if (mevcutCarpan * aktifBahis > MAX_KAZANC) {
            oyunuBitir(true);
            return;
        }

        // VERİ KAYDI VE UI
        grafikNoktalari.push({ val: parseFloat(mevcutCarpan.toFixed(2)) });
        if(grafikNoktalari.length > 50) grafikNoktalari.shift();

        uiCarpan.textContent = mevcutCarpan.toFixed(2) + "x";
        
        if (mevcutCarpan < 1.00) {
            uiCarpan.style.color = "#ffaa00";
        } else {
            uiCarpan.style.color = "#00ff7f";
        }

        drawGraph();
    }

    function oyunuBitir(kullaniciTopladi) {
        oyunDurumu = 'bitti';
        cancelAnimationFrame(animasyonFrameId);
        uiBtn.textContent = "OYNA";
        uiBtn.classList.remove('topla-modu');
        backgroundMusic.pause();

        let kazancMiktari = 0;
        let isWin = false;

        if (kullaniciTopladi && mevcutCarpan >= 1.00) {
            let geriOdeme = aktifBahis * mevcutCarpan;
            let kar = geriOdeme - aktifBahis;
            kazancMiktari = kar * 0.68;
            bakiye += aktifBahis + kazancMiktari;
            isWin = true;
            sonElDurumu = 'kazanç';
            
        } else if (kullaniciTopladi && mevcutCarpan < 1.00 && mevcutCarpan > 0.00) {
            let geriOdeme = aktifBahis * mevcutCarpan;
            bakiye += geriOdeme;
            isWin = false;
            sonElDurumu = 'kayıp';

        } else {
            mevcutCarpan = 0.00; 
            uiCarpan.textContent = "CRASH";
            uiCarpan.classList.add('crash');
            grafikNoktalari.push({ val: 0.00 });
            isWin = false;
            sonElDurumu = 'kayıp';
        }
        
        sonucEkle(mevcutCarpan, isWin);

        dinamikZoom = 1.0; 
        canvas.style.transform = `scale(1.0)`;
        updateUI();
        
        oyunuTekrarBaslat();
    }

    function oynaVeyaTopla() {
        if(oyunDurumu === 'bekliyor' || oyunDurumu === 'bitti') {
            if (otoBetAktif) {
                alert("Oto Oynatma Aktif. Lütfen önce durdurun.");
                return;
            }
            oyunuBaslat();
        } else if(oyunDurumu === 'oynuyor') {
            oyunuBitir(true); 
        }
    }

    function sonucEkle(val, win) {
        const d = document.createElement('div');
        let stil = (val >= 1.00 && win) ? 'kazanc' : 'kayip';
        d.className = `sonuc-item ${stil}`;
        if (val === 0.00) d.innerText = "CRASH";
        else d.innerText = val.toFixed(2) + 'x';
        uiListe.prepend(d);
        if(uiListe.children.length > 20) uiListe.lastElementChild.remove();
    }

    function drawGraph() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Başlangıçta boş tuvali göster
        if (grafikNoktalari.length < 2 && oyunDurumu !== 'oynuyor') {
             ctx.font = '24px Arial';
             ctx.fillStyle = '#1e90ff';
             ctx.textAlign = 'center';
             ctx.fillText('OYNA butonuna basın', canvas.width / 2, canvas.height / 2);
             return;
        }

        canvas.style.transform = `scale(${dinamikZoom})`;
        
        let maxVal = 1.5; 
        grafikNoktalari.forEach(p => { if(p.val > maxVal) maxVal = p.val; });
        maxVal = maxVal * 1.2; 

        const w = canvas.width;
        const h = canvas.height;
        const padding = 30;

        ctx.beginPath();
        ctx.lineWidth = 3;
        
        if (mevcutCarpan < 1.00) ctx.strokeStyle = "#ffaa00";
        else ctx.strokeStyle = "#00ff7f";
        if (grafikNoktalari[grafikNoktalari.length-1].val <= 0.01) ctx.strokeStyle = "#ff4d4d";

        grafikNoktalari.forEach((p, i) => {
            let x = (i / (grafikNoktalari.length - 1)) * w;
            let y = h - ((p.val / maxVal) * (h - padding));
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Kareler
        grafikNoktalari.forEach((p, i) => {
            let x = (i / (grafikNoktalari.length - 1)) * w;
            let y = h - ((p.val / maxVal) * (h - padding));

            if (p.val <= 0.01) ctx.fillStyle = "#ff4d4d";
            else if (p.val < 1.00) ctx.fillStyle = "#ffaa00";
            else ctx.fillStyle = "#00ff7f";

            if (i === grafikNoktalari.length - 1 && oyunDurumu === 'oynuyor') {
                 ctx.fillStyle = "#ffffff"; 
                 ctx.shadowBlur = 10;
                 ctx.shadowColor = "white";
            } else {
                 ctx.shadowBlur = 0;
            }
            ctx.fillRect(x - 4, y - 4, 8, 8);
        });
    }
</script>
