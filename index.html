<script>
    // JavaScript Başlangıcı - YENİ VE GELİŞTİRİLMİŞ VERSİYON

    const bakiyeGosterge = document.getElementById('bakiyeGosterge');
    const aktifBahisGosterge = document.getElementById('aktifBahisGosterge');
    const oynaToplaBtn = document.getElementById('oynaToplaBtn');
    const carpanGosterge = document.getElementById('carpanGosterge');
    const sonuclarAlani = document.getElementById('sonuclarAlani');
    const canvas = document.getElementById('grafikCanvas');
    const ctx = canvas.getContext('2d');

    let bakiye = 100.00;
    let aktifBahis = 10.00;
    let oyunBasladi = false;
    let mevcutCarpan = 1.00;
    let oyunHiziMs = 50; // 1.00x hız (50ms)
    let oyunInterval;
    let grafikNoktalari = []; // [çarpan1, çarpan2, ...]
    let grafikKapasitesi = 100; // Ekranda görünen maksimum nokta sayısı

    const CANVAS_HEIGHT = 350;
    const CANVAS_WIDTH = 760;
    const MAX_GOSTERIM = 10.0; // Y ekseninde maksimum gösterilecek çarpan değeri

    // --- UI ve Bahis Yönetimi ---
    function updateUI() {
        bakiyeGosterge.textContent = `₺${bakiye.toFixed(2)}`;
        aktifBahisGosterge.textContent = `₺${aktifBahis.toFixed(2)}`;
    }

    function setBahis(tutar) {
        if (oyunBasladi) return;
        aktifBahis = Math.max(10.00, Math.min(100.00, tutar));
        updateUI();
    }

    function ayarlaBahis(delta) {
        if (oyunBasladi) return;
        setBahis(aktifBahis + delta);
    }
    
    // --- Grafik Çizimi Fonksiyonu ---
    function cizGrafik() {
        ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

        if (grafikNoktalari.length < 2) return;

        ctx.beginPath();
        ctx.strokeStyle = '#00ff7f'; 
        ctx.lineWidth = 3;

        // Grafiği sağdan sola doğru kaydırarak çiz
        const noktaSayisi = grafikNoktalari.length;
        const cizilecekNoktalar = grafikNoktalari.slice(Math.max(0, noktaSayisi - grafikKapasitesi));
        const xStep = CANVAS_WIDTH / (grafikKapasitesi - 1 || 1); 

        // 1.00x'in Y ekseni başlangıç noktası (en altta değil, aşağıya yakın)
        const yBase = CANVAS_HEIGHT * 0.95; 

        cizilecekNoktalar.forEach((carpan, index) => {
            const x = index * xStep;
            
            // Çarpanı [1.00, MAX_GOSTERIM] aralığında normalize et
            const normalizedCarpan = Math.max(1.0, Math.min(MAX_GOSTERIM, carpan));
            
            // Oran: (çarpan - 1) / (maxGosterim - 1). Oran 0'dan 1'e gider.
            const oran = (normalizedCarpan - 1) / (MAX_GOSTERIM - 1);
            
            // Y pozisyonu: oran arttıkça yBase'den (aşağı) CANVAS_HEIGHT * 0.05'e (yukarı) doğru hareket eder.
            const y = yBase - (yBase - (CANVAS_HEIGHT * 0.05)) * oran;

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });

        ctx.stroke();
    }

    // --- Oyun Mantığı ---

    // Rastgele Dalgalanma Oluşturan Fonksiyon
    let momentum = 0.00; // Grafiğin eğilimini korumasına yardımcı olur
    function calculateNextCarpan() {
        // Mevcut momentumu rastgele değiştir (volatilite)
        momentum += (Math.random() - 0.5) * 0.008; // -0.004 ile 0.004 arası değişim
        momentum = Math.max(-0.02, Math.min(0.04, momentum)); // Momentum sınırları (sabit bir yükseliş eğilimi için üst limit daha yüksek)

        let nextCarpan = mevcutCarpan + momentum;
        
        // 1.00x altına inmesini engelle (Çarpan 1.00x'den başlamalı)
        // nextCarpan = Math.max(1.00, nextCarpan); 

        // Çarpanı 2 ondalık basamakta tut
        return parseFloat(nextCarpan.toFixed(2));
    }

    function turuBaslat() {
        if (bakiye < aktifBahis) {
            alert("Yetersiz bakiye!");
            return;
        }

        bakiye -= aktifBahis;
        updateUI();

        oyunBasladi = true;
        mevcutCarpan = 1.00;
        grafikNoktalari = [1.00];
        momentum = 0.01; // Başlangıçta hafif yukarı eğilim
        oynaToplaBtn.textContent = 'TOPLA';
        oynaToplaBtn.classList.add('topla-modu');
        carpanGosterge.textContent = mevcutCarpan.toFixed(2) + 'x';
        carpanGosterge.style.color = '#fff';
        
        turuCalistir();
    }

    function turuCalistir() {
        // Çarpanın sıfırlanma (crash) olasılığını kontrol eden sayac
        let turSayisi = 0; 
        
        oyunInterval = setInterval(() => {
            if (!oyunBasladi) {
                clearInterval(oyunInterval);
                return;
            }

            turSayisi++;
            mevcutCarpan = calculateNextCarpan();

            // Çarpan 1.00x'e ulaşmadan sıfırlanma: Çok nadir bir durum
            if (mevcutCarpan < 1.00 && turSayisi < 5) {
                // Çarpanı tekrar 1.00x'e çek, bu erken sıfırlanmayı simülasyonda azaltır.
                mevcutCarpan = 1.00;
            }

            // Kritik Sıfırlanma (Crash) Kontrolü
            // Çarpan yükseldikçe sıfırlanma olasılığı artar (Örn: 2x'te %0.5, 5x'te %2 vb.)
            let crashOlasilik = (mevcutCarpan - 1.0) * 0.005; // Çarpan 1'den büyükse olasılık başlar
            
            if (Math.random() < crashOlasilik) {
                mevcutCarpan = 0.00;
                grafikNoktalari.push(mevcutCarpan); // 0.00'ı grafiğe ekle
                turuBitir(false); // Kayıp
                return;
            }

            // UI güncellemesi
            carpanGosterge.textContent = mevcutCarpan.toFixed(2) + 'x';
            carpanGosterge.style.color = mevcutCarpan >= 1.00 ? '#00ff7f' : '#ff4d4d';
            
            grafikNoktalari.push(mevcutCarpan);
            cizGrafik();
        }, oyunHiziMs);
    }

    function turuBitir(kazanildi) {
        clearInterval(oyunInterval);
        oyunBasladi = false;
        oynaToplaBtn.textContent = 'OYNA';
        oynaToplaBtn.classList.remove('topla-modu');
        
        let sonucMetni = mevcutCarpan.toFixed(2);
        
        if (kazanildi) {
            const kazanc = aktifBahis * mevcutCarpan * 0.68; // %32 kesinti uygulandı
            bakiye += kazanc;
            sonucMetni = `${mevcutCarpan.toFixed(2)}x (KAZANÇ: ₺${kazanc.toFixed(2)})`;
        } else {
            sonucMetni = "0.00x (KAYIP)";
            carpanGosterge.textContent = "0.00x";
            carpanGosterge.style.color = '#ff4d4d';
        }
        
        ekleSonuc(sonucMetni, kazanildi);
        updateUI();
    }

    function ekleSonuc(sonuc, kazanildi) {
        const yeniSonucDiv = document.createElement('div');
        yeniSonucDiv.classList.add('sonuc-item');
        yeniSonucDiv.textContent = sonuc;
        if (!kazanildi) {
             yeniSonucDiv.style.backgroundColor = '#660000'; 
        } else {
             yeniSonucDiv.style.backgroundColor = '#4b0082'; // Kazanç için mor
        }

        // H3'ten sonra en üste ekle
        sonuclarAlani.insertBefore(yeniSonucDiv, sonuclarAlani.children[1]); 
        
        // Sadece son 20 sonucu göster
        while (sonuclarAlani.children.length > 21) {
            sonuclarAlani.removeChild(sonuclarAlani.lastChild);
        }
    }

    function oynaVeyaTopla() {
        if (oyunBasladi) {
            // TOPLA işlemi: Sadece 1.00x üzerinde toplayabilirsin
            if (mevcutCarpan > 1.00) {
                turuBitir(true); 
            } else {
                alert("Toplamak için çarpanın 1.00x'i geçmesini bekleyin!");
            }
        } else {
            // OYNA işlemi
            turuBaslat();
        }
    }

    // --- Olay Dinleyicileri ---
    
    // Hız Butonları
    document.querySelectorAll('.hiz-ayarlari button').forEach(button => {
        button.addEventListener('click', function() {
            if (oyunBasladi) return;
            
            document.querySelector('.hiz-ayarlari .aktif').classList.remove('aktif');
            this.classList.add('aktif');
            oyunHiziMs = parseInt(this.dataset.speed);
        });
    });

    // Oto Strateji Switch (Şimdilik sadece görsel)
    document.getElementById('otoStratejiSwitch').addEventListener('click', function() {
        this.classList.toggle('on');
    });

    // Sayfa Yüklendiğinde
    window.onload = () => {
        updateUI();
        // Canvas boyutlarını ayarlama
        canvas.width = document.querySelector('.grafik-alani').clientWidth - 4; 
        canvas.height = document.querySelector('.grafik-alani').clientHeight - 4;
        cizGrafik();
    };
    
</script>
